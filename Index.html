<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Application Pro</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Tailwind Config for Custom Colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        dark: {
                            bg: '#0f172a',
                            surface: '#1e293b',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Global & Reset --- */
        :root {
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        html.dark {
            --glass-border: rgba(255, 255, 255, 0.05);
            --glass-bg: rgba(30, 41, 59, 0.7);
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden; /* Prevent body scroll, handle in containers */
        }

        /* --- Scrollbars --- */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        html.dark .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #475569; }

        /* --- Glassmorphism Utilities --- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* --- Auth Screen Background --- */
        .auth-bg {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
        }
        html.dark .auth-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        /* --- Message Bubbles --- */
        .message-bubble-sent {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }
        .message-bubble-received {
            background-color: #f1f5f9;
            color: #1e293b;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        html.dark .message-bubble-received {
            background-color: #334155;
            color: #f1f5f9;
        }

        /* --- Inputs & Toggles --- */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        
        /* --- Media Queries --- */
        @media (max-width: 768px) {
            .mobile-fullscreen { height: 100dvh; } /* Dynamic Viewport Height */
        }

        /* --- Loader --- */
        .loader-ring {
            display: inline-block; width: 40px; height: 40px;
        }
        .loader-ring:after {
            content: " "; display: block; width: 32px; height: 32px; margin: 4px; border-radius: 50%;
            border: 3px solid #3b82f6; border-color: #3b82f6 transparent #3b82f6 transparent;
            animation: loader-ring 1.2s linear infinite;
        }
        @keyframes loader-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-dark-bg dark:text-slate-200 transition-colors duration-300">

    <!-- GLOBAL LOADING SPINNER -->
    <div id="loading-spinner" class="fixed inset-0 bg-white/80 dark:bg-slate-900/90 backdrop-blur-sm flex flex-col items-center justify-center z-[9999] hidden">
        <div class="loader-ring"></div>
        <p class="mt-4 text-sm font-medium text-primary animate-pulse">Loading...</p>
    </div>

    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-screen" class="auth-bg min-h-screen flex items-center justify-center p-4">
        <div class="glass w-full max-w-md p-8 rounded-2xl shadow-2xl animate-fade-in relative overflow-hidden">
            <!-- Decorative Background Blob -->
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-400/20 rounded-full blur-2xl"></div>
            <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-purple-400/20 rounded-full blur-2xl"></div>

            <div class="relative z-10">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white text-2xl shadow-lg mb-4">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h2 id="auth-title" class="text-3xl font-bold text-slate-800 dark:text-white">Welcome Back</h2>
                    <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm">Sign in to continue your conversations</p>
                </div>

                <form id="auth-form" class="space-y-4">
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-4 top-3.5 text-slate-400"></i>
                        <input id="email" type="email" placeholder="Email Address" class="w-full pl-11 pr-4 py-3 bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all dark:text-white" required>
                    </div>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-3.5 text-slate-400"></i>
                        <input id="password" type="password" placeholder="Password" class="w-full pl-11 pr-4 py-3 bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all dark:text-white" required>
                    </div>
                    
                    <div id="auth-error" class="hidden p-3 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 text-red-600 dark:text-red-400 text-sm text-center flex items-center justify-center gap-2">
                        <i class="fas fa-exclamation-circle"></i> <span>Error message here</span>
                    </div>

                    <button type="submit" id="auth-button" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 rounded-xl shadow-lg shadow-blue-500/30 transform hover:scale-[1.02] transition-all duration-200">
                        Login
                    </button>
                </form>

                <div class="mt-6 text-center text-sm text-slate-500 dark:text-slate-400">
                    <span id="auth-toggle-text">Don't have an account?</span>
                    <a href="#" id="auth-toggle-link" class="text-blue-600 dark:text-blue-400 font-semibold hover:underline ml-1">Sign Up</a>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="main-app" class="hidden h-screen w-full overflow-hidden bg-white dark:bg-dark-bg flex transition-opacity duration-500">
        
        <!-- SIDEBAR (Chat List) -->
        <div id="chat-list-container" class="w-full md:w-80 lg:w-96 bg-white dark:bg-dark-surface border-r border-slate-200 dark:border-slate-700 flex flex-col h-full relative z-20">
            
            <!-- Sidebar Header -->
            <div class="p-5 border-b border-slate-100 dark:border-slate-700/50 flex justify-between items-center bg-white/80 dark:bg-dark-surface/80 backdrop-blur sticky top-0 z-10">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight">Chats</h2>
                    <p class="text-xs text-slate-500 dark:text-slate-400" id="current-user-email-display"></p>
                </div>
                
                <!-- Profile Dropdown Trigger -->
                <div id="user-profile" class="relative group">
                    <div class="relative cursor-pointer transform hover:scale-105 transition-transform">
                        <img id="user-avatar" src="https://placehold.co/40x40" class="w-10 h-10 rounded-full object-cover ring-2 ring-slate-100 dark:ring-slate-700">
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-dark-surface rounded-full"></div>
                    </div>
                    
                    <!-- Dropdown Menu -->
                    <div id="user-menu" class="hidden absolute right-0 top-12 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 py-2 z-50 animate-fade-in origin-top-right">
                        <div class="px-4 py-2 border-b border-slate-100 dark:border-slate-700 mb-1">
                            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Settings</p>
                        </div>
                        <a href="#" id="theme-toggle-button" class="flex items-center px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                            <i class="fas fa-moon w-6 text-slate-400"></i> <span>Dark Mode</span>
                        </a>
                        <a href="#" id="edit-profile-button" class="flex items-center px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                            <i class="fas fa-user-edit w-6 text-slate-400"></i> Edit Profile
                        </a>
                        <a href="#" id="admin-panel-button" class="hidden flex items-center px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                            <i class="fas fa-shield-alt w-6 text-slate-400"></i> Admin Panel
                        </a>
                        <div class="border-t border-slate-100 dark:border-slate-700 my-1"></div>
                        <a href="#" id="logout-button" class="flex items-center px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                            <i class="fas fa-sign-out-alt w-6"></i> Logout
                        </a>
                    </div>
                </div>
            </div>

            <!-- Support Button -->
            <div class="px-4 pb-4 pt-2">
                <button id="chat-with-admin-btn" class="w-full bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 py-2.5 px-4 rounded-xl text-sm font-semibold hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition-colors flex items-center justify-center gap-2 border border-emerald-100 dark:border-emerald-800">
                    <i class="fas fa-headset"></i> Chat with Support
                </button>
            </div>

            <!-- User List -->
            <div id="user-list" class="flex-1 overflow-y-auto scrollbar-thin px-3 pb-4 space-y-1">
                <!-- Users injected here by JS -->
            </div>
        </div>

        <!-- CHAT WINDOW -->
        <div id="chat-window-wrapper" class="flex-1 flex flex-col bg-slate-50 dark:bg-dark-bg relative h-full hidden md:flex">
            
            <!-- Empty State -->
            <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center bg-slate-50 dark:bg-dark-bg z-0">
                <div class="w-24 h-24 bg-blue-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 animate-pulse">
                    <i class="fas fa-comments text-4xl text-blue-500"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Start a Conversation</h2>
                <p class="text-slate-500 max-w-sm">Select a contact from the left to start messaging securely.</p>
            </div>

            <!-- Active Chat Interface -->
            <div id="chat-window" class="hidden flex-1 flex flex-col h-full relative z-10 bg-cover bg-center" style="background-image: url('data:image/svg+xml,%3Csvg width=\'100\' height=\'100\' viewBox=\'0 0 100 100\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z\' fill=\'%239C92AC\' fill-opacity=\'0.05\' fill-rule=\'evenodd\'/%3E%3C/svg%3E');">
                
                <!-- Chat Header -->
                <div class="glass px-4 py-3 flex items-center justify-between z-20 sticky top-0 border-b border-slate-200/50 dark:border-slate-700/50 shadow-sm">
                    <div class="flex items-center">
                        <button id="back-to-chats-btn" class="md:hidden mr-3 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-slate-600 dark:text-slate-300">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        
                        <div class="relative">
                            <img id="chat-header-avatar" src="https://placehold.co/48x48" class="w-10 h-10 rounded-full object-cover ring-2 ring-white dark:ring-slate-700 shadow-sm cursor-pointer transform hover:scale-105 transition-transform">
                            <span id="chat-header-online-dot" class="hidden absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></span>
                        </div>
                        
                        <div class="ml-3">
                            <h3 id="chat-header-name" class="font-bold text-slate-800 dark:text-white text-base leading-tight">User Name</h3>
                            <div class="flex flex-col">
                                <div id="chat-header-status-info" class="flex items-center gap-2">
                                    <p id="chat-header-status" class="text-xs font-medium text-slate-500 dark:text-slate-400"></p>
                                    <p id="chat-header-last-seen" class="text-xs text-slate-400 dark:text-slate-500 truncate max-w-[150px]"></p>
                                </div>
                                <p id="typing-indicator" class="text-xs text-blue-500 font-medium h-4 transition-all"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Header Actions -->
                    <div class="flex items-center">
                        <button id="delete-chat-btn" class="text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 transition-all" title="Delete Chat">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin bg-slate-50/50 dark:bg-dark-bg/50">
                    <!-- Messages injected here -->
                </div>

                <!-- Input Area -->
                <div class="p-4 glass border-t border-slate-200 dark:border-slate-700 z-20">
                    
                    <!-- Context (Reply/Upload) -->
                    <div id="reply-bar" class="hidden mb-2 p-2 bg-slate-100 dark:bg-slate-700 rounded-lg border-l-4 border-blue-500 flex justify-between items-center animate-fade-in">
                        <div class="overflow-hidden mr-2">
                            <p class="text-xs font-bold text-blue-500 mb-0.5">Replying to</p>
                            <p id="reply-text" class="text-sm text-slate-600 dark:text-slate-300 truncate"></p>
                        </div>
                        <button id="cancel-reply-btn" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-500">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>

                    <!-- Sticker Picker Container -->
                    <div id="emoji-sticker-picker" class="hidden mb-2 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 max-h-48 overflow-y-auto scrollbar-thin grid grid-cols-8 gap-2 p-2"></div>

                    <!-- Input Controls -->
                    <div class="flex items-end gap-2">
                        <!-- Actions Menu -->
                        <div class="relative">
                            <button id="more-options-btn" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-slate-600 transition-colors flex items-center justify-center">
                                <i class="fas fa-plus"></i>
                            </button>
                            <div id="more-options-menu" class="hidden absolute bottom-12 left-0 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 py-2 z-50 animate-fade-in">
                                <button id="attach-file-btn" class="w-full px-4 py-2.5 text-sm text-left hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center text-slate-700 dark:text-slate-200">
                                    <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-500 flex items-center justify-center mr-3"><i class="fas fa-image"></i></div> Photo/Video
                                </button>
                                <button id="record-voice-btn" class="w-full px-4 py-2.5 text-sm text-left hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center text-slate-700 dark:text-slate-200">
                                    <div class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center mr-3"><i class="fas fa-microphone"></i></div> Voice Message
                                </button>
                            </div>
                        </div>

                        <!-- Main Input -->
                        <div class="flex-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl flex items-center shadow-sm focus-within:ring-2 focus-within:ring-blue-500/50 focus-within:border-blue-500 transition-all">
                            <button id="emoji-sticker-btn" class="p-3 text-slate-400 hover:text-yellow-500 transition-colors"><i class="far fa-smile text-lg"></i></button>
                            <button id="giphy-btn" class="p-2 text-slate-400 hover:text-pink-500 transition-colors font-bold text-xs border border-slate-200 dark:border-slate-600 rounded px-1">GIF</button>
                            <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 bg-transparent border-none focus:ring-0 py-3 px-2 text-slate-800 dark:text-white placeholder-slate-400">
                        </div>

                        <!-- Send Button -->
                        <button id="send-btn" class="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/30 flex items-center justify-center transform hover:scale-110 transition-all flex-shrink-0">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- Hidden Inputs/Status -->
                    <input type="file" id="file-input" class="hidden" accept="image/*,video/*">
                    <p id="recording-status" class="text-xs font-bold text-red-500 mt-2 hidden flex items-center animate-pulse"><span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span> Recording Audio...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                <h3 class="font-bold text-lg text-slate-800 dark:text-white">Edit Profile</h3>
                <button id="close-edit-profile-modal" class="text-slate-400 hover:text-slate-600 text-xl">&times;</button>
            </div>
            <div class="p-6 flex flex-col items-center">
                <div class="relative mb-6 group">
                    <img id="profile-avatar-preview" src="" class="w-24 h-24 rounded-full object-cover ring-4 ring-slate-100 dark:ring-slate-700">
                    <button id="change-avatar-btn" class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-2 shadow-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-camera text-sm"></i>
                    </button>
                </div>
                <input type="file" id="avatar-input" class="hidden" accept="image/*">
                
                <div class="w-full mb-6">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Display Name</label>
                    <input type="text" id="display-name-input" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none dark:text-white transition-all">
                </div>
                <button id="save-profile-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/20 transition-transform transform hover:scale-[1.02]">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Image Modal -->
    <div id="fullscreen-image-modal" class="hidden fixed inset-0 z-[100] bg-black/95 flex items-center justify-center backdrop-blur-md animate-fade-in" onclick="this.classList.add('hidden');">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white text-4xl focus:outline-none">&times;</button>
        <img id="fullscreen-image" src="" alt="Full-screen" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain cursor-zoom-out">
    </div>

    <!-- Giphy Modal -->
    <div id="giphy-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div id="giphy-content" class="bg-white dark:bg-slate-800 w-full max-w-2xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-bolt text-yellow-400"></i>
                    <h3 class="font-bold text-lg dark:text-white">GIPHY Search</h3>
                </div>
                <button id="close-giphy-modal" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-900/50">
                <input type="text" id="giphy-search-input" placeholder="Search GIFs..." class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-pink-500 outline-none dark:text-white">
            </div>
            <div id="giphy-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 gap-3 bg-white dark:bg-slate-800">
                <!-- GIFs -->
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden border border-slate-200 dark:border-slate-700">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                <h3 class="font-bold text-xl dark:text-white"><i class="fas fa-shield-alt text-blue-500 mr-2"></i>Admin Console</h3>
                <button id="close-admin-panel" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <!-- Admin Sidebar -->
                <div class="w-64 bg-slate-50 dark:bg-slate-900/50 border-r border-slate-100 dark:border-slate-700 p-4 hidden md:block">
                    <nav class="space-y-2">
                        <a href="#users" class="admin-tab-link block px-4 py-3 rounded-xl bg-blue-500 text-white font-medium shadow-md transition-all"><i class="fas fa-users w-6"></i> Users</a>
                        <a href="#content" class="admin-tab-link block px-4 py-3 rounded-xl text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-800 transition-all"><i class="fas fa-images w-6"></i> Stickers</a>
                        <a href="#registrations" class="admin-tab-link block px-4 py-3 rounded-xl text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-800 transition-all"><i class="fas fa-user-lock w-6"></i> Access</a>
                    </nav>
                </div>
                <!-- Admin Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Users Tab -->
                    <div id="admin-tab-users" class="admin-tab-content">
                        <h4 class="text-lg font-bold mb-4 dark:text-white">Manage Users</h4>
                        <div id="admin-user-list" class="space-y-3"></div>
                    </div>
                    <!-- Content Tab -->
                    <div id="admin-tab-content" class="admin-tab-content hidden">
                        <h4 class="text-lg font-bold mb-4 dark:text-white">Stickers & Custom Emojis</h4>
                        <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl mb-6">
                            <div class="flex gap-2">
                                <input type="text" id="new-sticker-url" placeholder="Image URL" class="flex-1 px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 dark:text-white">
                                <button id="add-sticker-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 rounded-lg font-medium">Add</button>
                            </div>
                        </div>
                        <div id="sticker-list-container" class="grid grid-cols-6 gap-4"></div>
                    </div>
                    <!-- Reg Tab -->
                    <div id="admin-tab-registrations" class="admin-tab-content hidden">
                        <h4 class="text-lg font-bold mb-4 dark:text-white">System Settings</h4>
                        <div class="bg-slate-50 dark:bg-slate-700/50 p-6 rounded-xl flex justify-between items-center">
                            <div>
                                <p class="font-bold text-slate-800 dark:text-white">Allow New Signups</p>
                                <p class="text-sm text-slate-500">Toggle to open/close registration for new users.</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span id="registration-status-text" class="text-sm font-bold text-slate-600 dark:text-slate-300">ON</span>
                                <div class="relative inline-block w-14 h-8 align-middle select-none">
                                    <input type="checkbox" name="registration-toggle" id="registration-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer top-1 left-1 transition-all duration-300"/>
                                    <label for="registration-toggle" class="toggle-label block overflow-hidden h-8 rounded-full bg-slate-300 dark:bg-slate-600 cursor-pointer transition-colors"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- --- JAVASCRIPT LOGIC --- -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyD86N7zF7rm_0_E_PuoSdD6cwQTGmIlL7s",
            authDomain: "dekha-5daeb.firebaseapp.com",
            databaseURL: "https://dekha-5daeb-default-rtdb.firebaseio.com",
            projectId: "dekha-5daeb",
            storageBucket: "dekha-5daeb.firebasestorage.app",
            messagingSenderId: "647841969799",
            appId: "1:647841969799:web:c133fdc1cc8ea986846a22"
        };
        const cloudinaryConfig = { cloud_name: "dl4rnmjyn", upload_preset: "chatting" };
        const ADMIN_EMAIL = "admin@example.com";
        const GIPHY_API_KEY = "UmalJbfKMvbuarXuOCztHglcJFQZrNSr";

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy, getDocs, writeBatch, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect, remove, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // Global State
        let currentUser = null;
        let isAdmin = false;
        let currentChatUser = null;
        let currentChatId = null;
        let unsubscribeMessages = null;
        let typingTimeout = null;
        let typingListenerRef = null;

        // Helper for UI State
        function setChatState(key, value) {
            if (key === 'currentUser') currentUser = value;
            if (key === 'isAdmin') isAdmin = value;
            if (key === 'currentChatUser') currentChatUser = value;
            if (key === 'currentChatId') currentChatId = value;
            if (key === 'unsubscribeMessages') unsubscribeMessages = value;
            if (key === 'typingTimeout') typingTimeout = value;
            if (key === 'typingListenerRef') typingListenerRef = value;
        }

        // --- PRESENCE & STATUS ---
        function setupPresence() {
            if (!currentUser) return;
            const userStatusDatabaseRef = ref(rtdb, '/status/' + currentUser.uid);
            const userStatusFirestoreRef = doc(db, 'users', currentUser.uid);
            const isOfflineForRTDB = { state: 'offline' };
            const isOnlineForRTDB = { state: 'online' };
            const isOfflineForFirestore = { isOnline: false, lastSeen: serverTimestamp() };
            const isOnlineForFirestore = { isOnline: true };
            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    set(userStatusDatabaseRef, isOnlineForRTDB);
                    updateDoc(userStatusFirestoreRef, isOnlineForFirestore);
                    onDisconnect(userStatusDatabaseRef).set(isOfflineForRTDB).then(() => {
                        updateDoc(userStatusFirestoreRef, isOfflineForFirestore);
                    });
                }
            });
        }

        let siteSettings = {};
        function listenToSiteSettings() {
            const settingsDocRef = doc(db, "siteSettings", "config");
            onSnapshot(settingsDocRef, (docSnap) => {
                siteSettings = docSnap.exists() ? docSnap.data() : { registrationsEnabled: true, stickers: [] };
                if (isAdmin){
                    const regToggle = document.getElementById('registration-toggle');
                    if(regToggle) {
                        regToggle.checked = siteSettings.registrationsEnabled;
                        document.getElementById('registration-status-text').innerText = siteSettings.registrationsEnabled ? "ON" : "OFF";
                    }
                }
                const authToggleText = document.getElementById('auth-toggle-text');
                const authToggleLink = document.getElementById('auth-toggle-link');
                if (!siteSettings.registrationsEnabled) {
                    authToggleText.classList.add('hidden');
                    authToggleLink.classList.add('hidden');
                } else {
                    authToggleText.classList.remove('hidden');
                    authToggleLink.classList.remove('hidden');
                }
            });
        }

        // --- USER LIST & CHAT START ---
        async function loadUserList() {
            const userListEl = document.getElementById('user-list');
            const q = query(collection(db, "users"));
            onSnapshot(q, (snapshot) => {
                userListEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.uid === currentUser.uid) return;
                    
                    // UX: Create modern User Card
                    const userEl = document.createElement('div');
                    userEl.className = 'group flex items-center p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer transition-all duration-200 border border-transparent hover:border-slate-200 dark:hover:border-slate-700';
                    userEl.dataset.uid = user.uid;
                    
                    userEl.innerHTML = `
                        <div class="relative">
                            <img src="${user.photoURL}" class="w-12 h-12 rounded-full mr-4 object-cover ring-2 ring-transparent group-hover:ring-blue-200 dark:group-hover:ring-slate-600 transition-all">
                            ${user.isOnline ? '<span class="absolute bottom-0 right-4 w-3 h-3 bg-green-500 border-2 border-white dark:border-dark-surface rounded-full shadow-sm"></span>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline">
                                <h4 class="font-semibold text-slate-800 dark:text-slate-200 truncate">${user.displayName}</h4>
                                ${user.isAdmin ? '<span class="text-[10px] font-bold px-1.5 py-0.5 bg-red-100 text-red-600 rounded ml-2 uppercase tracking-wider">Admin</span>' : ''}
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 truncate">Tap to chat</p>
                        </div>
                    `;
                    userEl.addEventListener('click', () => startChat(user));
                    userListEl.appendChild(userEl);
                });
            });
        }

        async function startChat(otherUser) {
            setChatState('currentChatUser', otherUser);
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('chat-window').classList.remove('hidden');
            
            // Mobile View Logic
            if (window.innerWidth < 768) {
                document.getElementById('chat-list-container').classList.add('hidden');
                document.getElementById('chat-window-wrapper').classList.remove('hidden');
                document.getElementById('main-app').classList.add('mobile-fullscreen');
            }

            document.getElementById('chat-header-avatar').src = otherUser.photoURL;
            document.getElementById('chat-header-name').textContent = otherUser.displayName;

            const userStatusRef = ref(rtdb, '/status/' + otherUser.uid);
            const userFirestoreRef = doc(db, 'users', otherUser.uid);
            const statusEl = document.getElementById('chat-header-status');
            const lastSeenEl = document.getElementById('chat-header-last-seen');
            const onlineDot = document.getElementById('chat-header-online-dot');

            onSnapshot(userFirestoreRef, (docSnap) => {
                const userData = docSnap.data();
                if (userData && userData.isOnline) {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'text-xs font-semibold text-green-500';
                    lastSeenEl.textContent = '';
                    onlineDot.classList.remove('hidden');
                } else {
                    if (userData && userData.lastSeen) {
                        const lastSeenTime = new Date(userData.lastSeen.toDate()).toLocaleString([], {hour: '2-digit', minute:'2-digit', day:'numeric', month:'short'});
                        lastSeenEl.textContent = `Last seen: ${lastSeenTime}`;
                    } else {
                        lastSeenEl.textContent = 'Offline';
                    }
                    statusEl.textContent = ''; // Hide "Offline" text, show last seen
                    onlineDot.classList.add('hidden');
                }
            });

            const uids = [currentUser.uid, otherUser.uid].sort();
            setChatState('currentChatId', uids.join('_'));
            const messagesRef = collection(db, 'chats', currentChatId, 'messages');
            const q = query(messagesRef);
            const querySnapshot = await getDocs(q);
            const batch = writeBatch(db);
            querySnapshot.forEach(docSnap => {
                const msg = docSnap.data();
                if (msg.senderUid !== currentUser.uid && !msg.seenAt) {
                    batch.update(doc(messagesRef, docSnap.id), { seenAt: serverTimestamp() });
                }
            });
            await batch.commit();
            loadMessages();
            const typingIndicatorEl = document.getElementById('typing-indicator');
            if (typingListenerRef) {
                off(typingListenerRef);
            }
            setChatState('typingListenerRef', ref(rtdb, `typing/${currentChatId}/${currentChatUser.uid}`));
            onValue(typingListenerRef, (snapshot) => {
                if (snapshot.exists() && snapshot.val() === true) {
                    typingIndicatorEl.textContent = 'Typing...';
                    lastSeenEl.classList.add('hidden');
                } else {
                    typingIndicatorEl.textContent = '';
                    lastSeenEl.classList.remove('hidden');
                }
            });
        }

        // --- MESSAGES & RENDERING ---
        function loadMessages() {
            if (unsubscribeMessages) unsubscribeMessages();
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            const messagesRef = collection(db, 'chats', currentChatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp'));
            setChatState('unsubscribeMessages', onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const msg = change.doc.data();
                    if (change.type === "added") {
                        const tempMsg = messagesContainer.querySelector(`[data-temp-content="${msg.content}"]`);
                        if (tempMsg) {
                            tempMsg.dataset.id = change.doc.id;
                            tempMsg.dataset.tempContent = '';
                            updateMessageStatus(tempMsg, msg);
                        } else {
                            displayMessage(msg, change.doc.id);
                        }
                    }
                    if (change.type === "modified") {
                        const existingMsg = messagesContainer.querySelector(`[data-id="${change.doc.id}"]`);
                        if (existingMsg) {
                            updateMessageStatus(existingMsg, msg);
                        }
                    }
                });
                // Smooth scroll to bottom
                setTimeout(() => {
                    messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
                }, 100);
            }));
        }

        async function displayMessage(msg, docId) {
            const messagesContainer = document.getElementById('messages-container');
            const isSent = msg.senderUid === currentUser.uid;
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-3 ${isSent ? 'justify-end' : 'justify-start'} animate-fade-in`;
            messageWrapper.dataset.id = docId;
            if (!docId) messageWrapper.dataset.tempContent = msg.content;
            
            let contentHtml = '';
            if (msg.replyToId) {
                const originalMsgRef = doc(db, 'chats', currentChatId, 'messages', msg.replyToId);
                const originalMsgSnap = await getDoc(originalMsgRef);
                const originalMsgContent = originalMsgSnap.exists() ? (originalMsgSnap.data().content || "Attachment") : "Message unavailable";
                // Styled reply context
                const replyHtml = `<div class="text-xs mb-1 p-2 rounded bg-black/10 dark:bg-white/10 border-l-2 border-blue-400">
                    <p class="opacity-70 font-medium">Replied to:</p>
                    <p class="truncate italic">${originalMsgContent}</p>
                </div>`;
                contentHtml += replyHtml;
            }
            
            // Content Type Handling with modern HTML
            switch(msg.type) {
                case 'text': contentHtml += `<p class="text-sm leading-relaxed whitespace-pre-wrap break-words font-sans">${msg.content}</p>`; break;
                case 'image': contentHtml += `<img src="${msg.url}" class="rounded-lg max-w-[250px] w-full shadow-sm cursor-pointer hover:opacity-90 transition-opacity" onclick="window.open('${msg.url}', '_blank')">`; break;
                case 'video': contentHtml += `<video controls src="${msg.url}" class="rounded-lg max-w-[250px] shadow-sm"></video>`; break;
                case 'audio': contentHtml += `<audio controls src="${msg.url}" class="max-w-[240px] h-10 mt-1"></audio>`; break;
                case 'sticker': contentHtml += `<img src="${msg.url}" class="w-28 h-28 object-contain hover:scale-110 transition-transform">`; break;
                case 'gif': contentHtml += `<img src="${msg.url}" class="rounded-lg max-w-[250px] shadow-sm giphy-gif">`; break;
            }

            const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
            const statusIcon = getMessageStatusIcon(msg, isSent);
            
            messageWrapper.innerHTML = `
                <div class="max-w-[80%] lg:max-w-[60%] flex flex-col ${isSent ? 'items-end' : 'items-start'}">
                    <div class="${isSent ? 'message-bubble-sent' : 'message-bubble-received'} p-3 shadow-sm relative group">
                         <div class="message-content">${contentHtml}</div>
                         <div class="absolute top-0 ${isSent ? '-left-8' : '-right-8'} hidden group-hover:flex h-full items-center">
                            <i class="fas fa-reply text-slate-400 text-xs cursor-pointer hover:text-blue-500"></i>
                         </div>
                    </div>
                    <div class="flex items-center mt-1 space-x-1 opacity-70">
                        <span class="text-[10px] ${isSent ? 'text-slate-600 dark:text-slate-300' : 'text-slate-500'}">${timestamp}</span>
                        ${isSent ? `<span class="text-[10px]">${statusIcon}</span>` : ''}
                    </div>
                </div>
            `;
            messagesContainer.appendChild(messageWrapper);
        }

        function getMessageStatusIcon(msg, isSent) {
            if (!isSent) return '';
            if (msg.seenAt) {
                return `<i class="fas fa-check-double text-blue-500"></i>`;
            } else if (msg.timestamp) {
                return `<i class="fas fa-check text-slate-400"></i>`;
            } else {
                return `<i class="fas fa-circle-notch fa-spin text-slate-400"></i>`;
            }
        }

        function updateMessageStatus(messageEl, msg) {
            const timestampEl = messageEl.querySelector('.opacity-70');
            const newTimestamp = new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const newIcon = getMessageStatusIcon(msg, true);
            // Rebuild status line
            timestampEl.innerHTML = `<span class="text-[10px] text-slate-600 dark:text-slate-300">${newTimestamp}</span> <span class="text-[10px]">${newIcon}</span>`;
        }

        async function sendMessage(type, content, url = null, replyToId = null) {
            if (!currentChatId || (!content && !url)) return;
            const messagesRef = collection(db, 'chats', currentChatId, 'messages');
            const tempMessage = {
                type, content, url, senderUid: currentUser.uid, timestamp: null, replyToId
            };
            displayMessage(tempMessage, null);
            await addDoc(messagesRef, { type, content, url, senderUid: currentUser.uid, timestamp: serverTimestamp(), replyToId });
            
            // Clear inputs
            document.getElementById('message-input').value = '';
            document.getElementById('reply-bar').classList.add('hidden');
            document.getElementById('emoji-sticker-picker').classList.add('hidden');
        }

        // --- MEDIA UPLOADS ---
        async function uploadFile(file) {
            if (!file) return;
            document.getElementById('loading-spinner').classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', cloudinaryConfig.upload_preset);
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloud_name}/${file.type.startsWith('image/') ? 'image' : 'video'}/upload`, {
                    method: 'POST', body: formData,
                });
                const data = await response.json();
                const type = file.type.startsWith('image/') ? 'image' : 'video';
                sendMessage(type, file.name, data.secure_url);
            } catch (error) {
                console.error("Upload failed:", error);
                alert("Failed to upload file.");
            } finally {
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        }

        async function uploadAudio(audioBlob) {
            if (!audioBlob) return;
            document.getElementById('loading-spinner').classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', audioBlob);
            formData.append('upload_preset', cloudinaryConfig.upload_preset);
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloud_name}/raw/upload`, {
                    method: 'POST', body: formData,
                });
                const data = await response.json();
                sendMessage('audio', 'Voice Message', data.secure_url);
            } catch (error) {
                console.error("Audio upload failed:", error);
            } finally {
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        }

        async function updateUserData(uid, data) {
            const userDocRef = doc(db, "users", uid);
            return updateDoc(userDocRef, data);
        }

        // --- EMOJI PICKER & STICKERS ---
        function initEmojiStickerPicker() {
            const picker = document.getElementById('emoji-sticker-picker');
            onSnapshot(doc(db, "siteSettings", "config"), (docSnap) => {
                const stickers = docSnap.exists() ? docSnap.data().stickers || [] : [];
                picker.innerHTML = '';
                
                // Categories (Tabs) could be added here, for now mixed
                const defaultEmojis = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
                
                defaultEmojis.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.className = 'text-2xl hover:bg-slate-100 dark:hover:bg-slate-700 rounded p-1 transition-colors';
                    btn.textContent = emoji;
                    btn.addEventListener('click', () => {
                        const input = document.getElementById('message-input');
                        input.value += btn.textContent;
                        input.focus();
                    });
                    picker.appendChild(btn);
                });
                
                stickers.forEach(sticker => {
                    const img = document.createElement('img');
                    img.src = sticker.url;
                    img.className = 'w-10 h-10 object-contain cursor-pointer hover:scale-110 transition-transform';
                    img.addEventListener('click', () => {
                        sendMessage('sticker', 'sticker', sticker.url);
                        picker.classList.add('hidden');
                    });
                    picker.appendChild(img);
                });
            });
        }

        // --- DOM ELEMENTS & UI LOGIC ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const chatListContainer = document.getElementById('chat-list-container');
        const chatWindowWrapper = document.getElementById('chat-window-wrapper');
        const backToChatsBtn = document.getElementById('back-to-chats-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const authForm = document.getElementById('auth-form');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authError = document.getElementById('auth-error');
        const authToggleText = document.getElementById('auth-toggle-text');
        const adminPanelButton = document.getElementById('admin-panel-button');
        const adminPanel = document.getElementById('admin-panel');
        const closeAdminPanel = document.getElementById('close-admin-panel');
        const giphyBtn = document.getElementById('giphy-btn');
        const giphyModal = document.getElementById('giphy-modal');
        const closeGiphyModal = document.getElementById('close-giphy-modal');
        const giphySearchInput = document.getElementById('giphy-search-input');
        const giphyGrid = document.getElementById('giphy-grid');
        const editProfileModal = document.getElementById('edit-profile-modal');
        const editProfileButton = document.getElementById('edit-profile-button');
        const closeEditProfileModal = document.getElementById('close-edit-profile-modal');
        const profileAvatarPreview = document.getElementById('profile-avatar-preview');
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const avatarInput = document.getElementById('avatar-input');
        const displayNameInput = document.getElementById('display-name-input');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const replyBar = document.getElementById('reply-bar');
        const replyText = document.getElementById('reply-text');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const chatHeaderAvatar = document.getElementById('chat-header-avatar');
        const deleteChatBtn = document.getElementById('delete-chat-btn');
        const fullscreenImageModal = document.getElementById('fullscreen-image-modal');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const recordVoiceBtn = document.getElementById('record-voice-btn');
        const recordingStatus = document.getElementById('recording-status');
        
        let isLogin = true;
        let replyToMessageId = null;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let gifSearchTimeout = null;

        function showAuthScreen() {
            authScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
        }
        
        function showMainApp() {
            authScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            chatListContainer.classList.remove('hidden');
            chatWindowWrapper.classList.add('hidden'); // Reset to list view on load
            if (window.innerWidth >= 768) {
                chatWindowWrapper.classList.remove('hidden'); // Split view on desktop
                chatWindowWrapper.classList.add('flex');
            }
        }

        // --- ADMIN PANEL LOGIC ---
        async function loadAdminUsers() {
            const userListEl = document.getElementById('admin-user-list');
            userListEl.innerHTML = '<div class="loader-ring"></div>';
            const usersRef = collection(db, "users");
            const q = query(usersRef, orderBy("displayName"));
            const querySnapshot = await getDocs(q);
            userListEl.innerHTML = '';
            querySnapshot.forEach(docSnapshot => {
                const user = docSnapshot.data();
                const userEl = document.createElement('div');
                userEl.className = 'p-4 bg-white dark:bg-slate-700 rounded-xl shadow-sm flex items-center justify-between border border-slate-100 dark:border-slate-600 transition-all hover:shadow-md';
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex items-center';
                infoDiv.innerHTML = `
                    <img src="${user.photoURL}" class="w-10 h-10 rounded-full mr-3 object-cover">
                    <div>
                        <p class="font-bold text-slate-800 dark:text-white">${user.displayName}</p>
                        <p class="text-xs text-slate-500">${user.email}</p>
                    </div>
                `;

                const actionDiv = document.createElement('div');
                actionDiv.className = 'flex items-center gap-3';
                
                const badge = document.createElement('span');
                badge.className = `text-[10px] font-bold px-2 py-1 rounded ${user.isAdmin ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`;
                badge.innerText = user.isAdmin ? 'ADMIN' : 'USER';
                actionDiv.appendChild(badge);

                // Add Delete Button (Don't let admin delete themselves)
                if (user.uid !== currentUser.uid) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/20 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/40 flex items-center justify-center transition-colors';
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt text-xs"></i>';
                    deleteBtn.title = "Delete User";
                    deleteBtn.onclick = () => deleteUserAccount(user.uid, user.displayName);
                    actionDiv.appendChild(deleteBtn);
                }

                userEl.appendChild(infoDiv);
                userEl.appendChild(actionDiv);
                userListEl.appendChild(userEl);
            });
        }

        async function deleteUserAccount(targetUid, name) {
            if(!confirm(`Are you sure you want to delete ${name}? This will remove their data and logout their session.`)) return;
            
            loadingSpinner.classList.remove('hidden');
            try {
                // 1. Delete Firestore Doc
                await deleteDoc(doc(db, "users", targetUid));
                // 2. Delete Active Session (Logs them out)
                await remove(ref(rtdb, `activeSessions/${targetUid}`));
                // 3. Delete Status
                await remove(ref(rtdb, `status/${targetUid}`));
                
                alert(`User ${name} has been deleted.`);
                loadAdminUsers(); // Refresh list
            } catch (error) {
                console.error("Delete failed:", error);
                alert("Failed to delete user. See console for details.");
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        function loadAdminStickers() {
            const stickerListEl = document.getElementById('sticker-list-container');
            onSnapshot(doc(db, "siteSettings", "config"), (docSnap) => {
                const stickers = docSnap.exists() ? docSnap.data().stickers || [] : [];
                stickerListEl.innerHTML = '';
                if (stickers.length === 0) {
                    stickerListEl.innerHTML = '<p class="col-span-6 text-center text-slate-400">No stickers found.</p>';
                    return;
                }
                stickers.forEach(sticker => {
                    const stickerWrapper = document.createElement('div');
                    stickerWrapper.className = 'relative group bg-slate-100 dark:bg-slate-600 rounded-lg p-2 flex items-center justify-center';
                    stickerWrapper.innerHTML = `
                        <img src="${sticker.url}" class="w-12 h-12 object-contain">
                        <button class="remove-sticker-btn absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    `;
                    stickerWrapper.querySelector('.remove-sticker-btn').addEventListener('click', () => removeSticker(sticker));
                    stickerListEl.appendChild(stickerWrapper);
                });
            });
        }

        async function addSticker() {
            const input = document.getElementById('new-sticker-url');
            const url = input.value.trim();
            if (!url) return;
            const settingsDocRef = doc(db, "siteSettings", "config");
            const newSticker = { url: url, addedAt: serverTimestamp() };
            try {
                await updateDoc(settingsDocRef, { stickers: arrayUnion(newSticker) });
                input.value = '';
            } catch (error) { console.error(error); }
        }

        async function removeSticker(sticker) {
            const settingsDocRef = doc(db, "siteSettings", "config");
            try { await updateDoc(settingsDocRef, { stickers: arrayRemove(sticker) }); } catch (error) { console.error(error); }
        }

        // --- INITIALIZATION ---
        const editProfileModalLogic = () => {
            editProfileButton.addEventListener('click', async (e) => {
                e.preventDefault();
                document.getElementById('user-menu').classList.add('hidden');
                editProfileModal.classList.remove('hidden');
                const userDocRef = doc(db, "users", currentUser.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    profileAvatarPreview.src = userData.photoURL || `https://ui-avatars.com/api/?name=${userData.displayName}`;
                    displayNameInput.value = userData.displayName || '';
                }
            });
            closeEditProfileModal.addEventListener('click', () => editProfileModal.classList.add('hidden'));
            changeAvatarBtn.addEventListener('click', () => avatarInput.click());
            avatarInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => profileAvatarPreview.src = e.target.result;
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            saveProfileBtn.addEventListener('click', async () => {
                loadingSpinner.classList.remove('hidden');
                const newDisplayName = displayNameInput.value.trim();
                let newPhotoURL = profileAvatarPreview.src;
                if (avatarInput.files[0]) {
                    const formData = new FormData();
                    formData.append('file', avatarInput.files[0]);
                    formData.append('upload_preset', cloudinaryConfig.upload_preset);
                    try {
                        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloud_name}/image/upload`, { method: 'POST', body: formData });
                        const data = await response.json();
                        newPhotoURL = data.secure_url;
                    } catch (error) { alert("Upload failed."); loadingSpinner.classList.add('hidden'); return; }
                }
                try {
                    await updateUserData(currentUser.uid, { displayName: newDisplayName, photoURL: newPhotoURL });
                    editProfileModal.classList.add('hidden');
                } catch (error) { alert("Update failed."); } finally { loadingSpinner.classList.add('hidden'); }
            });
        };

        const messageReplyLogic = () => {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.addEventListener('click', (e) => {
                // Find click in message bubble
                const messageWrapper = e.target.closest('.message-bubble-sent, .message-bubble-received');
                if (messageWrapper) {
                    const messageEl = messageWrapper.closest('[data-id]');
                    if (messageEl) {
                        replyToMessageId = messageEl.dataset.id;
                        const messageContentEl = messageWrapper.querySelector('.message-content');
                        replyText.textContent = messageContentEl.textContent || 'Attachment';
                        replyBar.classList.remove('hidden');
                        messageInput.focus();
                    }
                }
            });
            cancelReplyBtn.addEventListener('click', () => {
                replyToMessageId = null;
                replyBar.classList.add('hidden');
            });
            sendBtn.addEventListener('click', () => {
                const input = document.getElementById('message-input');
                if (input.value.trim()) {
                    sendMessage('text', input.value.trim(), null, replyToMessageId);
                    input.value = '';
                    replyToMessageId = null;
                }
            });
        };

        const themeToggleLogic = () => {
            const htmlEl = document.documentElement;
            const themeToggleBtn = document.getElementById('theme-toggle-button');
            const iconEl = themeToggleBtn.querySelector('i');
            const textEl = themeToggleBtn.querySelector('span');
            
            const setTheme = (theme) => {
                if (theme === 'dark') {
                    htmlEl.classList.add('dark');
                    iconEl.className = 'fas fa-sun w-6 text-yellow-400';
                    textEl.textContent = 'Light Mode';
                    localStorage.setItem('theme', 'dark');
                } else {
                    htmlEl.classList.remove('dark');
                    iconEl.className = 'fas fa-moon w-6 text-slate-400';
                    textEl.textContent = 'Dark Mode';
                    localStorage.setItem('theme', 'light');
                }
            };
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            themeToggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                setTheme(htmlEl.classList.contains('dark') ? 'light' : 'dark');
            });
        };

        const fullscreenImageLogic = () => {
            chatHeaderAvatar.addEventListener('click', () => {
                fullscreenImage.src = chatHeaderAvatar.src;
                fullscreenImageModal.classList.remove('hidden');
            });
        }

        const adminPanelLogic = () => {
            adminPanelButton.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('user-menu').classList.add('hidden');
                adminPanel.classList.remove('hidden');
                // Reset tabs
                document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById('admin-tab-users').classList.remove('hidden');
                loadAdminUsers();
            });
            closeAdminPanel.addEventListener('click', () => adminPanel.classList.add('hidden'));
            
            const tabLinks = document.querySelectorAll('.admin-tab-link');
            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Visual tab switching logic
                    const targetId = e.currentTarget.getAttribute('href').substring(1);
                    document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(`admin-tab-${targetId}`).classList.remove('hidden');
                    if(targetId === 'users') loadAdminUsers();
                    if(targetId === 'content') loadAdminStickers();
                });
            });
            document.getElementById('add-sticker-btn').addEventListener('click', addSticker);
            
            // Registration Toggle Logic
            const regToggle = document.getElementById('registration-toggle');
            if(regToggle) {
                regToggle.addEventListener('change', async (e) => {
                    const isEnabled = e.target.checked;
                    document.getElementById('registration-status-text').innerText = isEnabled ? "ON" : "OFF";
                    try {
                         await updateDoc(doc(db, "siteSettings", "config"), { registrationsEnabled: isEnabled });
                    } catch(err) { console.error(err); }
                });
            }
        };

        const voiceRecordingLogic = () => {
            recordVoiceBtn.addEventListener('click', async () => {
                if (isRecording) {
                    mediaRecorder.stop();
                    recordingStatus.classList.add('hidden');
                    isRecording = false;
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { 'type' : 'audio/webm; codecs=opus' });
                            uploadAudio(audioBlob);
                            stream.getTracks().forEach(track => track.stop());
                        };
                        mediaRecorder.start();
                        recordingStatus.classList.remove('hidden');
                        isRecording = true;
                    } catch (err) { alert("Microphone access denied."); }
                }
            });
        };

        function searchGifs(query) {
            if (!GIPHY_API_KEY) return;
            const url = query.trim() === '' ?
                `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=25` :
                `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=25`;
            fetch(url).then(r => r.json()).then(data => {
                giphyGrid.innerHTML = '';
                data.data.forEach(gif => {
                    const img = document.createElement('img');
                    img.src = gif.images.fixed_height.url;
                    img.className = 'w-full h-auto rounded-lg cursor-pointer hover:opacity-80';
                    img.addEventListener('click', () => {
                        sendMessage('gif', 'GIF', gif.images.original.url);
                        giphyModal.classList.add('hidden');
                    });
                    giphyGrid.appendChild(img);
                });
            }).catch(console.error);
        }

        function handleGiphySearch() {
            if (gifSearchTimeout) clearTimeout(gifSearchTimeout);
            gifSearchTimeout = setTimeout(() => searchGifs(giphySearchInput.value), 500);
        }

        async function updateSessionToken(uid) {
            const sessionToken = Math.random().toString(36).substring(2);
            await set(ref(rtdb, `activeSessions/${uid}`), sessionToken);
            localStorage.setItem('sessionToken', sessionToken);
            return sessionToken;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                setChatState('currentUser', user);
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                // Session Management
                const sessionRef = ref(rtdb, `activeSessions/${user.uid}`);
                onValue(sessionRef, async (snapshot) => {
                    const dbToken = snapshot.val();
                    const localToken = localStorage.getItem('sessionToken');
                    if (localToken && dbToken && dbToken !== localToken) {
                        alert("You have been logged out from this device.");
                        await signOut(auth);
                        return;
                    }
                });
                if (!localStorage.getItem('sessionToken')) await updateSessionToken(user.uid);

                if (userDocSnap.exists()) {
                    setChatState('isAdmin', userDocSnap.data().isAdmin || false);
                } else {
                    const newUserIsAdmin = user.email === ADMIN_EMAIL;
                    await setDoc(userDocRef, {
                        uid: user.uid, email: user.email, displayName: user.email.split('@')[0],
                        photoURL: `https://ui-avatars.com/api/?name=${user.email.split('@')[0]}&background=random`,
                        isAdmin: newUserIsAdmin
                    });
                    setChatState('isAdmin', newUserIsAdmin);
                }
                setupPresence();
                listenToSiteSettings();
                loadUI();
                editProfileModalLogic();
                messageReplyLogic();
                themeToggleLogic();
                fullscreenImageLogic();
                adminPanelLogic();
                voiceRecordingLogic();
            } else {
                setChatState('currentUser', null);
                localStorage.removeItem('sessionToken');
                showAuthScreen();
            }
        });

        function loadUI() {
            if (!currentUser) return;
            // Update sidebar header info
            document.getElementById('current-user-email-display').innerText = currentUser.email;
            const userDocRef = doc(db, "users", currentUser.uid);
            onSnapshot(userDocRef, (doc) => {
                 if(doc.exists()) {
                    const userData = doc.data();
                    document.getElementById('user-avatar').src = userData.photoURL || `https://ui-avatars.com/api/?name=${userData.email.split('@')[0]}`;
                 }
            });
            if(isAdmin) { document.getElementById('admin-panel-button').classList.remove('hidden'); }
            loadUserList();
            showMainApp();
            initEmojiStickerPicker();
        }

        // --- EVENT LISTENERS FOR AUTH & BASIC UI ---
        authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            document.getElementById('auth-title').textContent = isLogin ? 'Welcome Back' : 'Create Account';
            document.getElementById('auth-button').textContent = isLogin ? 'Login' : 'Sign Up';
            authToggleText.textContent = isLogin ? "Don't have an account?" : "Already have an account?";
            authToggleLink.textContent = isLogin ? 'Sign Up' : 'Login';
            authError.classList.add('hidden');
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');
            authError.classList.add('hidden');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                if(isLogin) {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    await updateSessionToken(userCredential.user.uid);
                } else {
                    const settingsDocSnap = await getDoc(doc(db, "siteSettings", "config"));
                    const registrationsEnabled = settingsDocSnap.exists() ? settingsDocSnap.data().registrationsEnabled : true;
                    if (!registrationsEnabled) throw new Error("RegistrationsDisabled");
                    
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateSessionToken(userCredential.user.uid);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                let msg = "Authentication failed.";
                if(error.message === "RegistrationsDisabled") msg = "Registration is currently disabled.";
                else if (error.code === 'auth/wrong-password') msg = "Invalid password.";
                else if (error.code === 'auth/user-not-found') msg = "User not found.";
                authError.classList.remove('hidden');
                authError.querySelector('span').innerText = msg;
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            const sessionRef = ref(rtdb, `activeSessions/${currentUser.uid}`);
            remove(sessionRef);
            signOut(auth);
        });

        document.getElementById('user-profile').addEventListener('click', () => {
            document.getElementById('user-menu').classList.toggle('hidden');
        });
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!document.getElementById('user-profile').contains(e.target)) {
                document.getElementById('user-menu').classList.add('hidden');
            }
        });

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendBtn.click();
        });

        // Typing Indicator Logic
        document.getElementById('message-input').addEventListener('input', () => {
            if (!currentChatId) return;
            const typingRef = ref(rtdb, `typing/${currentChatId}/${currentUser.uid}`);
            set(typingRef, true);
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => set(typingRef, false), 2000);
        });

        document.getElementById('attach-file-btn').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', (e) => { if (e.target.files[0]) uploadFile(e.target.files[0]); });

        document.getElementById('delete-chat-btn').addEventListener('click', async () => {
            if (!currentChatId || !currentChatUser) return;
            if (confirm(`Delete chat with ${currentChatUser.displayName}?`)) {
                loadingSpinner.classList.remove('hidden');
                try {
                    const messagesRef = collection(db, 'chats', currentChatId, 'messages');
                    const querySnapshot = await getDocs(messagesRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    document.getElementById('messages-container').innerHTML = '';
                } catch (error) { console.error(error); } finally { loadingSpinner.classList.add('hidden'); }
            }
        });

        document.getElementById('emoji-sticker-btn').addEventListener('click', () => document.getElementById('emoji-sticker-picker').classList.toggle('hidden'));
        document.getElementById('more-options-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('more-options-menu').classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!document.getElementById('more-options-btn').contains(e.target)) {
                document.getElementById('more-options-menu').classList.add('hidden');
            }
        });

        document.getElementById('chat-with-admin-btn').addEventListener('click', async () => {
            const q = query(collection(db, "users"));
            const snapshot = await getDocs(q);
            let adminUser = null;
            snapshot.forEach(doc => { if(doc.data().isAdmin && doc.data().uid !== currentUser.uid) adminUser = doc.data(); });
            if (adminUser) startChat(adminUser); else alert("No admin available.");
        });

        backToChatsBtn.addEventListener('click', () => {
            document.getElementById('main-app').classList.remove('mobile-fullscreen');
            chatListContainer.classList.remove('hidden');
            chatWindowWrapper.classList.add('hidden');
            document.getElementById('chat-window').classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
        });

        giphyBtn.addEventListener('click', () => {
            giphyModal.classList.remove('hidden');
            searchGifs('');
        });
        closeGiphyModal.addEventListener('click', () => giphyModal.classList.add('hidden'));
        giphySearchInput.addEventListener('input', handleGiphySearch);

    </script>
</body>
</html>
